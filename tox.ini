[tox]
requires = tox>=4.21
env_list = latest-deps-{cpu,gpu}-{py313,py314}, cli-{cpu,gpu}-{py313,py314}
skip_missing_interpreters = true

[testenv:latest-deps-base]
basepython =
    py314: python3.14
    py313: python3.13
package = skip
recreate = true
passenv =
    HF_*
    CUDA_*
    XLA_*
    JAX_*
    TORCH_*
setenv =
    UV_NO_SYNC = 1
    HF_XET_HIGH_PERFORMANCE = 1
    cpu: CUDA_VISIBLE_DEVICES = ""
    cpu: JAX_PLATFORMS = cpu
    gpu: CUDA_VISIBLE_DEVICES = 0
    gpu: JAX_PLATFORMS = cuda
# in deps we include a reduced set of dependencies needed to run tests;
# the reason is simply that the whole 'dev' dep group is unstable due to deprecated packages
deps =
    pytest
    pytest-xdist
    hypothesis

[testenv:latest-deps-{cpu,gpu}-{py313,py314}]
base = latest-deps-base
description = Latest deps tests with dev dependencies
allowlist_externals:
    uv
commands_pre =
    cpu: uv pip install --group dev ".[cpu]"
    gpu: uv pip install --group dev ".[cuda]"
commands =
    cpu: pytest -n=auto tests/unit # run only units for faster ci
    gpu: pytest -n=auto tests/unit tests/generation tests/tts

[testenv:cli-{cpu,gpu}-{py313,py314}]
base = latest-deps-base
description = CLI tests (pytest + shell smoke tests)
allowlist_externals =
    bash
    grep
commands_pre =
    cpu: python -m pip install .
    gpu: python -m pip install ".[cuda]"
commands =
    gpu: pytest tests/cli
    bash -c 'MODEL="Qwen/Qwen2.5-0.5B-Instruct" && \
        lalamo list-models | grep " $MODEL " && \
        lalamo list-models --plain | grep -x "$MODEL" && \
        lalamo list-models --no-plain | grep " $MODEL " && \
        lalamo convert "$MODEL" && \
        lalamo chat models/* --message "What is 2 + 2? Reply with a single number, nothing else." | grep -x "4<|im_end|>"'
